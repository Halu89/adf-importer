modules:
  jira:globalPage:
    - key: settings
      resource: settings
      resolver:
        function: resolver
      render: native
      title: ADF Importer settings

  jira:issueActivity:
    - key: adf-importer-hello-world-issue-activity
      resource: issueActivity
      resolver:
        function: resolver
      render: native
      title: adf-importer

  function:
    - key: resolver
      handler: index.handler

    - key: handleAttachmentAdded
      handler: index.handleAttachmentAdded

    - key: handleAttachmentDeleted
      handler: index.handleAttachmentDeleted

    - key: handleIssueDeleted
      handler: index.handleIssueDeleted

    - key: handleIssueUpdated
      handler: index.handleIssueUpdated

  trigger:
    - key: issue-attachment-added
      function: handleAttachmentAdded
      events:
        - avi:jira:created:attachment
      filter:
        ignoreSelf: true
        expression: |
          event.attachment.mimeType == "text/plain"
          || event.attachment.mimeType == "binary/octet-stream"
        onError: RECEIVE_AND_LOG

    - key: issue-attachment-deleted
      function: handleAttachmentDeleted
      events:
        - avi:jira:deleted:attachment
      filter:
        ignoreSelf: true
        expression: |
          event.attachment.mimeType == "text/plain"
          || event.attachment.mimeType == "binary/octet-stream"
        onError: RECEIVE_AND_LOG

    - key: issue-deleted
      function: handleIssueDeleted
      events:
        - avi:jira:deleted:issue
      filter:
        ignoreSelf: true
        onError: RECEIVE_AND_LOG

    - key: issue-updated
      function: handleIssueUpdated
      events:
        - avi:jira:updated:issue
      filter:
        ignoreSelf: true
        # Check if the update includes a status change to Resolved
        expression: |
          try {
             return event.changelog.items
                .reduce(
                    (acc, changelogItem) => changelogItem.field == "status" && changelogItem.toString?.includes("Resolved") 
                  ? acc + 1 
                  : acc,
                0) > 0
          } catch (e) {
            throw `Unexpected error: "${e.location}" - ${e.message}.`;
          }
        onError: RECEIVE_AND_LOG


permissions:
  scopes:
    - "read:jira-work" # Read events and attachments from Jira issues
    - "write:jira-work" # Create comments on Jira issues
    - "read:space:confluence" # Read space information in Confluence for the configuration
    - "write:page:confluence" # Create pages in Confluence
    - "search:confluence"
    - "delete:page:confluence" # Delete pages in Confluence for cleanup
    - "storage:app" # Store references to pages created from attachments

  external:
    fetch:
      backend:
        - "*.atlassian.net" # Create pages in external Confluence instances

resources:
  - key: issueActivity
    path: src/frontend/modules/IssueActivityModule.tsx

  - key: settings
    path: src/frontend/modules/SettingsModule.tsx

app:
  # Preview Multi-app support
  runtime:
    name: nodejs22.x
    memoryMB: 256
    architecture: arm64
  id: ari:cloud:ecosystem::app/c2decf0d-0aa0-4ac9-bc64-4e3fb6d21205
  compatibility:
    confluence:
      required: false
    jira:
      required: true

